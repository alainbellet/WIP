<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Data Filtering Test - WSL</title>
  <script src="https://d3js.org/d3.v4.0.0-alpha.40.min.js"></script>
</head>

<body>
  <style>
    table,
    th,
    td {
      border: 1px solid black;

    }

    table {
      width: 100%;

    }

    table tr:hover {
      background-color: grey;
      color: white;
    }
  </style>
  <div id="filters">
    <select id="Sektor" name="Sektor" class="mydataselector" multiple size="10">
      <option value="*" selected>All</option>
      <option value="Verkehr">Verkehr</option>
      <option value="Tourismus">Tourismus</option>
      <option value="LW">LW</option>
      <option value="Forstwirtschaft">Forstwirtschaft</option>
      <option value="Energieproduktion">Energieproduktion</option>
      <option value="Energiekonsum">Energiekonsum</option>
      <option value="Siedlung">Siedlung</option>
      <option value="Abwasser">Abwasser</option>
      <option value="Hochwasserschutz">Hochwasserschutz</option>

    </select>
    <select id="Subventionstatus" name="Subventionstatus" class="mydataselector" multiple size="10">
      <option value="*" selected>All</option>
      <option value="Off-Budget">Off-Budget</option>
      <option value="On-Budget">On-Budget</option>
      <option value="Fehlanreiz">Fehlanreiz</option>
      <option value="Implizite Subvention">Implizite Subvention</option>
    </select>

    <select id="NegativeWirkung" name="NegativeWirkung" class="mydataselector" multiple size="10">
      <option value="*" selected>All</option>
      <option value="x">x</option>
      <option value="xx">xx</option>
      <option value="xxx">xxx</option>
      <option value="o">o</option>
    </select>

    <input type="reset" value="Clear" onclick="clearTable()">

    <div id="NrOfResults">Results</div>
    </form>
  </div>
  <div id="tabledisplay"></div>
  <script type="text/javascript">
    // Our new builder function
    buildFilter = (filter) => {
      let query = {};
      for (let keys in filter) {
        if ((filter[keys].constructor === Object) || (filter[keys].constructor === Array && filter[keys].length > 0)) {
          query[keys] = filter[keys];
        }
      }
      return query;
    }

    // Our new filter function
    filterData = (data, query) => {
      // const keysWithMinMax = [
      //   'listPrice',
      //   'bedrooms'
      // ];
      const keysWithMinMax = [];

      const filteredData = data.filter((item) => {
        for (let key in query) {
          /* Note: this initial check can be modified in case
           *       you still want to include results that may
           *       not have that specific key.
           *
           *       If that is the case, you can just change these
           *       checks to:
           *
           *       if (item[key] !=== undefined) {
           *           if (keysWithMinMax.includes(key)) {
           *              ...
           *           }
           *           else if (!query[key].includes(item[key])) {
           *              ...
           *           }
           *       }
           *
           *       This way your program won't crash when the key doesn't
           *       exist.
           */
          if (item[key] === undefined) {
            return false;
          } else if (keysWithMinMax.includes(key)) {
            if (query[key]['min'] !== null && item[key] < query[key]['min']) {
              return false;
            }
            if (query[key]['max'] !== null && item[key] > query[key]['max']) {
              return false;
            }
          } else if (!query[key].includes(item[key])) {
            return false;
          }
        }
        return true;
      });
      return filteredData;
    };



    // Initial query
    // const fs = require('fs');
    // const file = fs.readFileSync('housing_data.json');
    // const data = JSON.parse(file);
    // let query = buildFilter(filter); // <-- Now this has been initialized with 'let'
    //
    // let result = filterData(data, query); // <-- Now this has been initialized with 'let'
    // console.log(JSON.stringify(result, null, 4));
    //
    // console.log('----------------------'); // For easier reading in the console

    // Updated filter
    let filter = {
      Sektor: [],
      Subventionstatus: [],
      NegativeWirkung: [],
    };

    // Updated query
    d3.selectAll(".mydataselector")
      .on("change", function(d) {
        let values = []
        selected = d3.select(this) // select the select
          .selectAll("option:checked") // select the selected values
          .each(function() {
            values.push(this.value)
          }); // for each of those, get its value

        if (values[0] == '*') { // widcard for all (workaround)
          values = []; // empty the Array
        }
        console.log(values)
        filter[this.name] = values;
        console.log(filter);
        outputFilterResults();
      })

    let datasource = 'https://alainbellet.github.io/WIP/WSL/data/subventionen_large.csv'
    let dataset = [];
    let nrOfResults = 0;

    const t = d3.csv(datasource, function(data) {
      dataset = data;
      console.log(dataset);
      outputFilterResults();
    });

    outputFilterResults = () => {
      query = buildFilter(filter);
      result = filterData(dataset, query);
      console.log(JSON.stringify(result, null, 4));
      console.log(result.length + ' results ------------------'); // For easier reading in the console
      console.log(JSON.stringify(filter, null, 4));
      let columns = ['Nr', 'Sektor', 'Subventionsbezeichnung', 'Subventionsart', 'Subventionstatus', 'Negative Wirkung', 'Schwierigkeit', 'Biodiversitätsschädigender', 'Budget', 'Budget Quelle', 'Rechtsgrundlage', 'Anpassung', 'Quelle'];
      clearTable();
      updateTable(result, columns);
      d3.select("#NrOfResults").text(result.length + " Result(s)")
    }

    updateTable = (data, columns) => {
      let table = d3.select('#tabledisplay').append('table')
      let thead = table.append('thead')
      let tbody = table.append('tbody')
      thead.append('tr').selectAll('th').data(columns).enter().append('th').text(function(d) {
        return d
      })
      let rows = tbody.selectAll('tr').data(data).enter().append('tr')
      let cells = rows.selectAll('td').data(function(row) {
        return columns.map(function(column) {
          return {
            column: column,
            value: row[column]
          }
        })
      }).enter().append('td').text(function(d) {
        return d.value
      })
      return table;
    }

    clearTable = () => {
      let table = d3.select('#tabledisplay').selectAll("table").remove();
    }





  </script>
</body>

</html>
